<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earthquake & Smoke Monitoring Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --gray: #6c757d;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --body-bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --header-bg: rgba(255, 255, 255, 0.05);
            --scrollbar-thumb: rgba(67, 97, 238, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body {
            background: var(--body-bg);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        body.day-mode {
            --dark: #f8f9fa;
            --light: #1a1a2e;
            --card-bg: rgba(26, 26, 46, 0.05);
            --card-border: rgba(26, 26, 46, 0.1);
            --text-primary: #1a1a2e;
            --text-secondary: #4a4a6e;
            --body-bg: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            --header-bg: rgba(26, 26, 46, 0.05);
            --scrollbar-thumb: rgba(67, 97, 238, 0.3);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toggle-btn {
            background: rgba(67, 97, 238, 0.2);
            border: 1px solid rgba(67, 97, 238, 0.3);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        body.day-mode .toggle-btn {
            background: rgba(26, 26, 46, 0.1);
            border-color: rgba(26, 26, 46, 0.2);
            color: #1a1a2e;
        }

        .toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--header-bg);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 250px;
        }

        .logo-icon {
            font-size: 2.5rem;
            color: var(--success);
        }

        body.day-mode .logo-icon {
            color: var(--primary);
        }

        .logo-text h1 {
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            background: linear-gradient(90deg, #4cc9f0, #4361ee);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .logo-text p {
            color: var(--text-secondary);
            font-size: clamp(0.8rem, 3vw, 0.9rem);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 50px;
            border: 1px solid rgba(0, 255, 0, 0.3);
            white-space: nowrap;
        }

        body.day-mode .connection-status {
            background: rgba(0, 200, 0, 0.1);
            border-color: rgba(0, 200, 0, 0.3);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            background: #0f0;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Main Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(300px, 100%), 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: clamp(15px, 3vw, 25px);
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        body.day-mode .card {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.05);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .card-title {
            font-size: clamp(1rem, 3vw, 1.2rem);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: clamp(1.2rem, 3vw, 1.5rem);
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: clamp(0.7rem, 2vw, 0.85rem);
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-normal { background: rgba(76, 201, 240, 0.2); color: #4cc9f0; }
        .badge-alert { background: rgba(247, 37, 133, 0.2); color: #f72585; animation: alert-pulse 1s infinite; }
        .badge-warning { background: rgba(248, 150, 30, 0.2); color: #f8961e; }

        body.day-mode .badge-normal { background: rgba(76, 201, 240, 0.1); }
        body.day-mode .badge-alert { background: rgba(247, 37, 133, 0.1); }
        body.day-mode .badge-warning { background: rgba(248, 150, 30, 0.1); }

        @keyframes alert-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Sensor Cards */
        .sensor-value {
            font-size: clamp(2rem, 8vw, 3.5rem);
            font-weight: 700;
            text-align: center;
            margin: 20px 0;
            color: var(--text-primary);
        }

        .sensor-unit {
            font-size: clamp(1rem, 3vw, 1.2rem);
            color: var(--text-secondary);
        }

        .sensor-progress {
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        body.day-mode .sensor-progress {
            background: rgba(26, 26, 46, 0.1);
        }

        .progress-bar {
            height: 100%;
            border-radius: 5px;
            transition: width 1s ease-in-out;
        }

        .progress-safe { background: linear-gradient(90deg, #4cc9f0, #4361ee); }
        .progress-warning { background: linear-gradient(90deg, #f8961e, #f3722c); }
        .progress-danger { background: linear-gradient(90deg, #f72585, #b5179e); }

        /* Chart Container */
        .chart-container {
            grid-column: 1 / -1;
            height: 300px;
        }

        .chart-card {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .chart-wrapper {
            flex-grow: 1;
            position: relative;
            min-height: 200px;
        }

        /* Alert History */
        .history-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #4cc9f0;
        }

        body.day-mode .history-item {
            background: rgba(26, 26, 46, 0.03);
        }

        .history-item.earthquake { border-left-color: #f72585; }
        .history-item.smoke { border-left-color: #f8961e; }

        .history-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .history-type {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Controls */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(180px, 100%), 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .control-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px 15px;
            background: rgba(67, 97, 238, 0.1);
            border: 1px solid rgba(67, 97, 238, 0.3);
            border-radius: 15px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            min-height: 120px;
        }

        body.day-mode .control-btn {
            background: rgba(67, 97, 238, 0.05);
        }

        .control-btn:hover {
            background: rgba(67, 97, 238, 0.2);
            transform: translateY(-3px);
        }

        .control-btn i {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            color: #4cc9f0;
        }

        .control-btn.danger {
            background: rgba(247, 37, 133, 0.1);
            border-color: rgba(247, 37, 133, 0.3);
        }

        body.day-mode .control-btn.danger {
            background: rgba(247, 37, 133, 0.05);
        }

        .control-btn.danger i {
            color: #f72585;
        }

        .control-btn.warning {
            background: rgba(248, 150, 30, 0.1);
            border-color: rgba(248, 150, 30, 0.3);
        }

        body.day-mode .control-btn.warning {
            background: rgba(248, 150, 30, 0.05);
        }

        .control-btn.warning i {
            color: #f8961e;
        }

        .control-btn h3 {
            font-size: clamp(0.9rem, 3vw, 1rem);
            margin: 0;
        }

        .control-btn p {
            font-size: clamp(0.75rem, 2.5vw, 0.85rem);
            color: var(--text-secondary);
            margin: 0;
        }

        /* System Info */
        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(200px, 100%), 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            font-size: clamp(0.85rem, 2.5vw, 0.9rem);
        }

        body.day-mode .info-item {
            background: rgba(26, 26, 46, 0.03);
        }

        .info-label {
            color: var(--text-secondary);
        }

        .info-value {
            font-weight: 600;
            color: #4cc9f0;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: clamp(0.8rem, 2.5vw, 0.9rem);
            margin-top: 30px;
            border-top: 1px solid var(--card-border);
            line-height: 1.5;
        }

        /* Responsive Breakpoints */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
                padding: 15px;
            }
            
            .logo {
                justify-content: center;
                min-width: auto;
            }
            
            .theme-toggle {
                position: absolute;
                top: 15px;
                right: 15px;
            }
            
            .toggle-btn {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            
            .connection-status {
                font-size: 0.9rem;
                padding: 8px 15px;
            }
            
            .dashboard-grid {
                gap: 15px;
            }
            
            .card {
                padding: 15px;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .controls-grid {
                gap: 10px;
            }
            
            .control-btn {
                padding: 15px 10px;
                min-height: 100px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .header {
                border-radius: 15px;
                margin-bottom: 20px;
            }
            
            .logo {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .logo-icon {
                font-size: 2rem;
            }
            
            .status-badge {
                padding: 4px 10px;
                font-size: 0.75rem;
            }
            
            .chart-container {
                height: 200px;
            }
            
            .controls-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .system-info {
                grid-template-columns: 1fr;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        body.day-mode ::-webkit-scrollbar-track {
            background: rgba(26, 26, 46, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(67, 97, 238, 0.7);
        }

        /* Mobile-specific adjustments */
        @media (hover: none) {
            .card:hover {
                transform: none;
            }
            
            .control-btn:hover {
                transform: none;
                background: rgba(67, 97, 238, 0.1);
            }
            
            .control-btn.danger:hover {
                background: rgba(247, 37, 133, 0.1);
            }
            
            .control-btn.warning:hover {
                background: rgba(248, 150, 30, 0.1);
            }
        }

        /* Landscape mode for mobile */
        @media (max-height: 600px) and (orientation: landscape) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chart-container {
                grid-column: span 2;
                height: 200px;
            }
            
            .history-container {
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Theme Toggle -->
        <div class="theme-toggle">
            <div class="toggle-btn" id="themeToggle">
                <i class="fas fa-moon"></i>
            </div>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="logo-text">
                    <h1>SeismicGuard Pro</h1>
                    <p>Real-time Earthquake & Smoke Monitoring System</p>
                </div>
            </div>
            <div class="connection-status">
                <div class="status-dot"></div>
                <span>Connected to ESP32</span>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- System Status Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-tachometer-alt card-icon"></i>
                        <span>System Status</span>
                    </div>
                    <div id="system-status-badge" class="status-badge badge-normal">NORMAL</div>
                </div>
                <div class="sensor-value" id="system-status-text">OPERATIONAL</div>
                <div class="sensor-progress">
                    <div id="system-health-bar" class="progress-bar progress-safe" style="width: 95%"></div>
                </div>
                <div class="info-item">
                    <span class="info-label">Uptime:</span>
                    <span class="info-value" id="uptime">00:00:00</span>
                </div>
            </div>

            <!-- Smoke Level Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-smog card-icon"></i>
                        <span>Smoke Level</span>
                    </div>
                    <div id="smoke-status-badge" class="status-badge badge-normal">SAFE</div>
                </div>
                <div class="sensor-value">
                    <span id="smoke-value">0</span>
                    <span class="sensor-unit">PPM</span>
                </div>
                <div class="sensor-progress">
                    <div id="smoke-progress" class="progress-bar progress-safe" style="width: 10%"></div>
                </div>
                <div class="info-item">
                    <span class="info-label">Threshold:</span>
                    <span class="info-value">300 PPM</span>
                </div>
            </div>

            <!-- Vibration Status Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-mountain card-icon"></i>
                        <span>Seismic Activity</span>
                    </div>
                    <div id="vibration-status-badge" class="status-badge badge-normal">STABLE</div>
                </div>
                <div class="sensor-value">
                    <span id="vibration-level">0</span>
                    <span class="sensor-unit">Level</span>
                </div>
                <div class="sensor-progress">
                    <div id="vibration-progress" class="progress-bar progress-safe" style="width: 5%"></div>
                </div>
                <div class="info-item">
                    <span class="info-label">Last Event:</span>
                    <span class="info-value" id="last-vibration-time">Never</span>
                </div>
            </div>

            <!-- Alerts Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-bell card-icon"></i>
                        <span>Alerts</span>
                    </div>
                    <div class="status-badge badge-normal" id="alert-count-badge">0</div>
                </div>
                <div class="sensor-value">
                    <span id="active-alerts">0</span>
                    <span class="sensor-unit">Active</span>
                </div>
                <div style="margin-top: 20px;">
                    <div class="info-item">
                        <span class="info-label">Earthquake:</span>
                        <span class="info-value" id="earthquake-alerts">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Smoke:</span>
                        <span class="info-value" id="smoke-alerts">0</span>
                    </div>
                </div>
            </div>

            <!-- Real-time Chart -->
            <div class="chart-container">
                <div class="card chart-card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-chart-line card-icon"></i>
                            <span>Real-time Sensor Data</span>
                        </div>
                        <div class="status-badge badge-normal">
                            <span id="chart-time-range">Last 5 min</span>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="sensorChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Alert History -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-history card-icon"></i>
                        <span>Recent Events</span>
                    </div>
                </div>
                <div class="history-container" id="alert-history">
                    <!-- Events will be populated here -->
                    <div class="history-item">
                        <div class="history-type">
                            <i class="fas fa-info-circle"></i>
                            <span>System Started</span>
                        </div>
                        <div class="history-time" id="current-time">Just now</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="controls-grid">
            <div class="control-btn" onclick="sendCommand('test_alert')">
                <i class="fas fa-bullhorn"></i>
                <div>
                    <h3>Test Alert</h3>
                    <p>Test all alarms</p>
                </div>
            </div>
            
            <div class="control-btn warning" onclick="sendCommand('silence')">
                <i class="fas fa-volume-mute"></i>
                <div>
                    <h3>Silence Alarm</h3>
                    <p>Stop current alert</p>
                </div>
            </div>
            
            <div class="control-btn" onclick="sendCommand('reset')">
                <i class="fas fa-redo"></i>
                <div>
                    <h3>Reset System</h3>
                    <p>Reset to normal</p>
                </div>
            </div>
            
            <div class="control-btn" onclick="sendCommand('calibrate')">
                <i class="fas fa-sliders-h"></i>
                <div>
                    <h3>Calibrate</h3>
                    <p>Calibrate sensors</p>
                </div>
            </div>
            
            <div class="control-btn danger" onclick="sendCommand('emergency_stop')">
                <i class="fas fa-power-off"></i>
                <div>
                    <h3>Emergency Stop</h3>
                    <p>Stop all systems</p>
                </div>
            </div>
        </div>

        <!-- System Information -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-microchip card-icon"></i>
                    <span>System Information</span>
                </div>
            </div>
            <div class="system-info">
                <div class="info-item">
                    <span class="info-label">Device ID:</span>
                    <span class="info-value" id="device-id">ESP32-MONITOR-001</span>
                </div>
                <div class="info-item">
                    <span class="info-label">WiFi Signal:</span>
                    <span class="info-value" id="wifi-strength">-45 dBm</span>
                </div>
                <div class="info-item">
                    <span class="info-label">IP Address:</span>
                    <span class="info-value" id="ip-address">192.168.1.100</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Last Update:</span>
                    <span class="info-value" id="last-update">Just now</span>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>SeismicGuard Pro Monitoring System | ESP32 Module | Â© 2024 All Rights Reserved</p>
            <p>Version 2.1.0 | Update Frequency: <span id="update-freq">2s</span> | <span id="connection-status">Connected</span></p>
        </div>
    </div>

    <script>
        // Global variables
        let sensorChart;
        let smokeHistory = [];
        let vibrationHistory = [];
        let alertHistory = [];
        let maxHistoryPoints = 50;
        let lastUpdateTime = new Date();
        let updateInterval = 2000; // Update every 2 seconds
        let earthquakeCount = 0;
        let smokeAlertCount = 0;
        let isDayMode = false;

        // Initialize Chart
        function initChart() {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            const gridColor = isDayMode ? 'rgba(26, 26, 46, 0.1)' : 'rgba(255, 255, 255, 0.1)';
            const textColor = isDayMode ? '#4a4a6e' : '#aaa';
            
            sensorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Smoke Level (PPM)',
                            data: [],
                            borderColor: '#4cc9f0',
                            backgroundColor: isDayMode ? 'rgba(76, 201, 240, 0.05)' : 'rgba(76, 201, 240, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Vibration Level',
                            data: [],
                            borderColor: '#f8961e',
                            backgroundColor: isDayMode ? 'rgba(248, 150, 30, 0.05)' : 'rgba(248, 150, 30, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 500
                    },
                    scales: {
                        x: {
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: isDayMode ? '#1a1a2e' : '#fff',
                                font: {
                                    size: window.innerWidth < 768 ? 10 : 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: isDayMode ? 'rgba(255, 255, 255, 0.9)' : 'rgba(26, 26, 46, 0.9)',
                            titleColor: isDayMode ? '#1a1a2e' : '#fff',
                            bodyColor: isDayMode ? '#1a1a2e' : '#fff',
                            borderColor: '#4361ee',
                            borderWidth: 1
                        }
                    }
                }
            });
        }

        // Toggle day/night mode
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');
            const icon = themeToggle.querySelector('i');
            
            isDayMode = !isDayMode;
            body.classList.toggle('day-mode');
            
            if (isDayMode) {
                icon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'day');
            } else {
                icon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'night');
            }
            
            // Update chart colors
            if (sensorChart) {
                updateChartTheme();
            }
        }

        // Update chart theme
        function updateChartTheme() {
            const gridColor = isDayMode ? 'rgba(26, 26, 46, 0.1)' : 'rgba(255, 255, 255, 0.1)';
            const textColor = isDayMode ? '#4a4a6e' : '#aaa';
            
            sensorChart.options.scales.x.grid.color = gridColor;
            sensorChart.options.scales.x.ticks.color = textColor;
            sensorChart.options.scales.y.grid.color = gridColor;
            sensorChart.options.scales.y.ticks.color = textColor;
            sensorChart.options.plugins.legend.labels.color = isDayMode ? '#1a1a2e' : '#fff';
            sensorChart.options.plugins.tooltip.backgroundColor = isDayMode ? 'rgba(255, 255, 255, 0.9)' : 'rgba(26, 26, 46, 0.9)';
            sensorChart.options.plugins.tooltip.titleColor = isDayMode ? '#1a1a2e' : '#fff';
            sensorChart.options.plugins.tooltip.bodyColor = isDayMode ? '#1a1a2e' : '#fff';
            
            // Update dataset colors
            sensorChart.data.datasets[0].backgroundColor = isDayMode ? 'rgba(76, 201, 240, 0.05)' : 'rgba(76, 201, 240, 0.1)';
            sensorChart.data.datasets[1].backgroundColor = isDayMode ? 'rgba(248, 150, 30, 0.05)' : 'rgba(248, 150, 30, 0.1)';
            
            sensorChart.update();
        }

        // Check saved theme preference
        function checkThemePreference() {
            const savedTheme = localStorage.getItem('theme');
            const themeToggle = document.getElementById('themeToggle');
            
            if (savedTheme === 'day') {
                isDayMode = true;
                document.body.classList.add('day-mode');
                themeToggle.querySelector('i').className = 'fas fa-sun';
            } else {
                isDayMode = false;
                document.body.classList.remove('day-mode');
                themeToggle.querySelector('i').className = 'fas fa-moon';
            }
        }

        // Update sensor data from ESP32
        async function updateSensorData() {
            try {
                // For demo purposes, generate random data
                // In real implementation, fetch from your ESP32
                const demoData = {
                    smoke_value: Math.floor(Math.random() * 500),
                    vibration_detected: Math.random() > 0.8,
                    current_state: Math.random() > 0.9 ? (Math.random() > 0.5 ? 1 : 2) : 0,
                    wifi_rssi: -45 - Math.floor(Math.random() * 20),
                    ip_address: '192.168.1.100'
                };
                
                // Update current time
                document.getElementById('current-time').textContent = getCurrentTime();
                document.getElementById('last-update').textContent = 'Just now';
                
                // Update system status
                updateSystemStatus(demoData);
                
                // Update sensor values
                document.getElementById('smoke-value').textContent = demoData.smoke_value;
                document.getElementById('vibration-level').textContent = demoData.vibration_detected ? '100' : '0';
                
                // Update progress bars
                updateProgressBars(demoData);
                
                // Update chart
                updateChartData(demoData);
                
                // Update system info
                document.getElementById('wifi-strength').textContent = demoData.wifi_rssi + ' dBm';
                
                // Update alert counts
                if (demoData.current_state === 1 && !demoData.vibration_detected) {
                    earthquakeCount++;
                    addAlertToHistory('Earthquake Detected!', 'earthquake');
                }
                if (demoData.current_state === 2 && demoData.smoke_value > 300) {
                    smokeAlertCount++;
                    addAlertToHistory(`Smoke Alert: ${demoData.smoke_value} PPM`, 'smoke');
                }
                
                document.getElementById('earthquake-alerts').textContent = earthquakeCount;
                document.getElementById('smoke-alerts').textContent = smokeAlertCount;
                document.getElementById('alert-count-badge').textContent = earthquakeCount + smokeAlertCount;
                
            } catch (error) {
                console.error('Error fetching sensor data:', error);
                document.getElementById('connection-status').textContent = 'Disconnected';
                document.getElementById('connection-status').style.color = '#f72585';
            }
        }

        // Update system status
        function updateSystemStatus(data) {
            const statusBadge = document.getElementById('system-status-badge');
            const statusText = document.getElementById('system-status-text');
            const vibrationBadge = document.getElementById('vibration-status-badge');
            const smokeBadge = document.getElementById('smoke-status-badge');
            
            // Update main system status
            switch(data.current_state) {
                case 0: // NORMAL
                    statusBadge.className = 'status-badge badge-normal';
                    statusBadge.textContent = 'NORMAL';
                    statusText.textContent = 'OPERATIONAL';
                    statusText.style.color = '#4cc9f0';
                    break;
                case 1: // EARTHQUAKE
                    statusBadge.className = 'status-badge badge-alert';
                    statusBadge.textContent = 'ALERT!';
                    statusText.textContent = 'EARTHQUAKE!';
                    statusText.style.color = '#f72585';
                    
                    vibrationBadge.className = 'status-badge badge-alert';
                    vibrationBadge.textContent = 'ACTIVE!';
                    document.getElementById('last-vibration-time').textContent = 'Now!';
                    
                    // Play alert sound
                    playAlertSound('earthquake');
                    break;
                case 2: // SMOKE
                    statusBadge.className = 'status-badge badge-alert';
                    statusBadge.textContent = 'ALERT!';
                    statusText.textContent = 'SMOKE DETECTED!';
                    statusText.style.color = '#f72585';
                    
                    smokeBadge.className = 'status-badge badge-alert';
                    smokeBadge.textContent = 'HIGH';
                    
                    // Play alert sound
                    playAlertSound('smoke');
                    break;
            }
            
            // Update vibration status
            if (data.vibration_detected && data.current_state !== 1) {
                vibrationBadge.className = 'status-badge badge-warning';
                vibrationBadge.textContent = 'MOVEMENT';
                document.getElementById('last-vibration-time').textContent = 'Recent';
            } else if (!data.vibration_detected && data.current_state === 0) {
                vibrationBadge.className = 'status-badge badge-normal';
                vibrationBadge.textContent = 'STABLE';
            }
            
            // Update smoke status
            if (data.smoke_value > 400) {
                smokeBadge.className = 'status-badge badge-alert';
                smokeBadge.textContent = 'DANGER';
            } else if (data.smoke_value > 300) {
                smokeBadge.className = 'status-badge badge-warning';
                smokeBadge.textContent = 'HIGH';
            } else if (data.smoke_value > 200) {
                smokeBadge.className = 'status-badge badge-warning';
                smokeBadge.textContent = 'MODERATE';
            } else {
                smokeBadge.className = 'status-badge badge-normal';
                smokeBadge.textContent = 'SAFE';
            }
        }

        // Update progress bars
        function updateProgressBars(data) {
            // Smoke progress
            const smokeProgress = document.getElementById('smoke-progress');
            const smokeWidth = Math.min((data.smoke_value / 500) * 100, 100);
            smokeProgress.style.width = smokeWidth + '%';
            
            if (data.smoke_value > 400) {
                smokeProgress.className = 'progress-bar progress-danger';
            } else if (data.smoke_value > 300) {
                smokeProgress.className = 'progress-bar progress-warning';
            } else {
                smokeProgress.className = 'progress-bar progress-safe';
            }
            
            // Vibration progress
            const vibrationProgress = document.getElementById('vibration-progress');
            const vibrationWidth = data.vibration_detected ? 100 : 5;
            vibrationProgress.style.width = vibrationWidth + '%';
            vibrationProgress.className = data.vibration_detected ? 'progress-bar progress-danger' : 'progress-bar progress-safe';
            
            // Active alerts
            const activeAlerts = document.getElementById('active-alerts');
            const alertCount = (data.current_state !== 0 ? 1 : 0) + (data.smoke_value > 300 ? 1 : 0);
            activeAlerts.textContent = alertCount;
            
            if (alertCount > 0) {
                activeAlerts.style.color = '#f72585';
                document.getElementById('alert-count-badge').className = 'status-badge badge-alert';
            } else {
                activeAlerts.style.color = '#4cc9f0';
                document.getElementById('alert-count-badge').className = 'status-badge badge-normal';
            }
        }

        // Update chart data
        function updateChartData(data) {
            const now = new Date();
            const timeLabel = now.getHours().toString().padStart(2, '0') + ':' + 
                             now.getMinutes().toString().padStart(2, '0') + ':' + 
                             now.getSeconds().toString().padStart(2, '0');
            
            // Add new data
            sensorChart.data.labels.push(timeLabel);
            sensorChart.data.datasets[0].data.push(data.smoke_value);
            sensorChart.data.datasets[1].data.push(data.vibration_detected ? 100 : 0);
            
            // Keep only last 20 points
            if (sensorChart.data.labels.length > maxHistoryPoints) {
                sensorChart.data.labels.shift();
                sensorChart.data.datasets[0].data.shift();
                sensorChart.data.datasets[1].data.shift();
            }
            
            // Update chart
            sensorChart.update('none');
        }

        // Add alert to history
        function addAlertToHistory(message, type) {
            const historyContainer = document.getElementById('alert-history');
            const alertItem = document.createElement('div');
            alertItem.className = `history-item ${type}`;
            
            alertItem.innerHTML = `
                <div class="history-type">
                    <i class="fas ${type === 'earthquake' ? 'fa-mountain' : 'fa-smog'}"></i>
                    <span>${message}</span>
                </div>
                <div class="history-time">${getCurrentTime()}</div>
            `;
            
            // Add to top
            historyContainer.insertBefore(alertItem, historyContainer.firstChild);
            
            // Keep only last 10 items
            if (historyContainer.children.length > 10) {
                historyContainer.removeChild(historyContainer.lastChild);
            }
        }

        // Send command to ESP32
        async function sendCommand(command) {
            try {
                // In real implementation, send to your ESP32
                console.log(`Sending command: ${command}`);
                
                // Show notification
                showNotification(`Command sent: ${command}`, 'success');
                
                // Add to history
                addAlertToHistory(`Command: ${command}`, 'info');
                
            } catch (error) {
                console.error('Error sending command:', error);
                showNotification('Failed to send command', 'error');
            }
        }

        // Show notification
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'success' ? 'rgba(76, 201, 240, 0.9)' : 'rgba(247, 37, 133, 0.9)'};
                color: white;
                border-radius: 10px;
                z-index: 1000;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                animation: slideIn 0.3s ease-out;
                max-width: calc(100vw - 40px);
                word-wrap: break-word;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
            
            // Add CSS animations
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Play alert sound
        function playAlertSound(type) {
            // You can implement browser notification sounds here
            if (type === 'earthquake') {
                // Play earthquake alert sound
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(400, audioContext.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                } catch (e) {
                    console.log('Audio play failed:', e);
                }
            }
        }

        // Get current time formatted
        function getCurrentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + 
                   now.getMinutes().toString().padStart(2, '0') + ':' + 
                   now.getSeconds().toString().padStart(2, '0');
        }

        // Update uptime counter
        function updateUptime() {
            const startTime = new Date();
            setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - startTime) / 1000);
                const hours = Math.floor(diff / 3600);
                const minutes = Math.floor((diff % 3600) / 60);
                const seconds = diff % 60;
                
                document.getElementById('uptime').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Handle window resize
        function handleResize() {
            if (sensorChart) {
                sensorChart.resize();
            }
        }

        // Initialize everything
        window.onload = function() {
            // Check saved theme
            checkThemePreference();
            
            // Initialize chart
            initChart();
            
            // Set up event listeners
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            window.addEventListener('resize', handleResize);
            
            // Update sensor data
            updateUptime();
            updateSensorData();
            
            // Then update every 2 seconds
            setInterval(updateSensorData, updateInterval);
            
            // Update connection status
            setInterval(() => {
                document.getElementById('connection-status').textContent = 'Connected';
                document.getElementById('connection-status').style.color = '#0f0';
            }, 5000);
            
            // Add initial demo data
            setTimeout(() => {
                addAlertToHistory('System calibration complete', 'info');
                addAlertToHistory('Smoke sensor initialized', 'smoke');
                addAlertToHistory('Vibration sensor ready', 'earthquake');
            }, 1000);
        };
    </script>
</body>
</html>
